Metadata:
  name: SobolSensitivityAnalysisCarsTrucks-1024
  author: mcschrader@crimson.ua.edu
  output: /home/max/Development/airport-harper-simulation/tmp/SobolSensitivityAnalysisCarsTrucks-1024/11.28.2023_15.57.14
  run_id: '0'
  cwd: /home/max/Development/airport-harper-simulation/tmp/SobolSensitivityAnalysisCarsTrucks-1024/11.28.2023_15.57.14/0
  simulation_root: /home/max/Development/airport-harper-simulation/simulation
  random_seed: 42
Blocks:
  FuelTotalConfig:
    emissions_xml: ${Metadata.cwd}/emissions.out.xml
    sim_step: ${Blocks.SimulationConfig.step_length}
    total_energy: 29226632537.540607
    total_vehicles: 5052
    delete_xml: true
    output_time_filter_lower: ${Blocks.SimulationConfig.warmup_time}
    output_time_filter_upper: null
    polygon_file: ${Metadata.simulation_root}/additional/polygons/emission_filter.poly.add
  XMLChangeOutputConfig:
    changes:
    - source: ${Metadata.simulation_root}/additional/detectors/e2.detectors.add.xml
      target: ${Metadata.cwd}/e2.detectors.add.xml
      new_output: NUL
    - source: ${Metadata.simulation_root}/additional/detectors/radar.e2.add.xml
      target: ${Metadata.cwd}/radar.e2.add.xml
      new_output: ${Metadata.cwd}/radar.e2.out.add.xml
    - source: ${Metadata.simulation_root}/additional/detectors/per_phase.e2.add.xml
      target: ${Metadata.cwd}/per_phase.e2.add.xml
      new_output: ${Metadata.cwd}/radar.e2.out.add.xml
  XMLConvertConfig:
    source: ${Metadata.cwd}/trip_info.out.xml
    target: ${Metadata.cwd}/trip_info.parquet
    elements:
    - name: tripinfo
      attributes:
      - id
      - depart
      - departLane
      - departPos
      - departSpeed
      - departDelay
      - arrival
      - arrivalLane
      - arrivalPos
      - arrivalSpeed
      - duration
      - routeLength
      - waitingTime
      - waitingCount
      - stopTime
      - timeLoss
      - rerouteNo
      - devices
      - vtype
    - name: emissions
      attributes:
      - CO_abs
      - CO2_abs
      - HC_abs
      - PMx_abs
      - NOx_abs
      - fuel_abs
    format: parquet
    delete_source: true
  SobolSequenceConfig:
    save_path: ${Metadata.output}/sobol_sequence.parquet
    params:
      RandomSeed:
        bounds:
        - 0.0
        - 100000.0
        val: 43102.9474362731
      FleetComposition:
        bounds:
        - 0.03
        - 0.25
        val: 0.2091609539091587
      TruckSpeedFactor:
        bounds:
        - 0.85
        - 1.1
        val: 1.051603191671893
      TruckAccel:
        bounds:
        - 0.8
        - 1.4
        val: 0.8320740107446909
      TruckTau:
        bounds:
        - 1.0
        - 2.0
        val: 1.2979392316192389
      TruckDecel:
        bounds:
        - 0.8
        - 4.0
        val: 3.4876095920801164
      Tau:
        bounds:
        - 0.71
        - 2.0
        val: 1.6101308453921228
      TauDev:
        bounds:
        - 0.334
        - 0.507
        val: 0.4384855024497956
      TauDist:
        bounds:
        - 0.0
        - 3.0
        val: 2.41868687979877
      Accel:
        bounds:
        - 0.8
        - 2.6
        val: 1.0063852682709695
      AccelDev:
        bounds:
        - 0.1012
        - 0.5
        val: 0.31188316838815805
      AccelDist:
        bounds:
        - 0.0
        - 3.0
        val: 2.019188697449863
      Decel:
        bounds:
        - 0.8
        - 4.5
        val: 2.2099226049147545
      DecelDev:
        bounds:
        - 0.725
        - 1.849
        val: 1.3926955667175354
      DecelDist:
        bounds:
        - 0.0
        - 3.0
        val: 1.2691231789067388
      minGap:
        bounds:
        - 1.5
        - 3.5
        val: 2.225901460275054
      minGapDev:
        bounds:
        - 0.96
        - 1.2
        val: 0.9783434794843197
      minGapDist:
        bounds:
        - 0.0
        - 3.0
        val: 0.8022096427157521
      speedFactor:
        bounds:
        - 0.9
        - 1.15
        val: 1.0918921212200074
      speedDev:
        bounds:
        - 0.1
        - 0.28
        val: 0.2764573277719319
      speedFactorDist:
        bounds:
        - 0.0
        - 2.0
        val: 0.531352860853076
      impatience:
        bounds:
        - 0.05
        - 0.55
        val: 0.1725088988430798
    'N': 1024
    calc_second_order: false
  MultiTypeCFConfig:
    configs:
    - save_path: ${Metadata.cwd}/${.vehicle_distribution_name}.in.xml
      vehicle_distribution_name: truckDist
      cf_params:
        carFollowModel:
          distribution: uniform
          params: {}
          bounds: []
          val: IDM
          is_attr: true
        emissionClass:
          distribution: uniform
          params: {}
          bounds: []
          val: PHEMlight/HDV_TT_D_EU6
          is_attr: true
        minGap:
          distribution: normal
          params:
            mu: 4.629724
            sd: 0.489
          bounds:
          - 1.75
          - 6.36
          val: null
          is_attr: false
        length:
          distribution: uniform
          params:
            a: 19.0
            b: 23.0
          bounds: []
          val: null
          is_attr: false
        vClass:
          distribution: uniform
          params: {}
          bounds: []
          val: trailer
          is_attr: true
        actionStepLength:
          distribution: uniform
          params: {}
          bounds: []
          val: 0.2
          is_attr: true
        jmTimegapMinor:
          distribution: uniform
          params: {}
          bounds: []
          val: 6.5
          is_attr: true
        lcPushy:
          distribution: uniform
          params:
            a: 0.0
            b: 0.2
          bounds: []
          val: null
          is_attr: false
        tau:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.TauDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.TruckTau.val},${Blocks.SobolSequenceConfig.params.TauDev.val}}
          bounds:
          - 0.2
          - 2.5
          val: null
          is_attr: false
        accel:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.AccelDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.TruckAccel.val},${Blocks.SobolSequenceConfig.params.AccelDev.val}}
          bounds:
          - 0.5
          - 2
          val: null
          is_attr: false
        decel:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.DecelDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.TruckDecel.val},${Blocks.SobolSequenceConfig.params.DecelDev.val}}
          bounds:
          - 0.2
          - 4.5
          val: null
          is_attr: false
        speedFactor:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.speedFactorDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.TruckSpeedFactor.val},${Blocks.SobolSequenceConfig.params.speedDev.val}}
          bounds:
          - 0.7
          - 1.15
          val: null
          is_attr: false
      seed: ${Blocks.SobolSequenceConfig.params.RandomSeed.val}
      decimal_places: 5
      num_samples: ${int:${math:1000 * ${Blocks.SobolSequenceConfig.params.FleetComposition.val}}}
    - save_path: ${Metadata.cwd}/${.vehicle_distribution_name}.in.xml
      vehicle_distribution_name: carDist
      cf_params:
        carFollowModel:
          distribution: uniform
          params: {}
          bounds: []
          val: IDM
          is_attr: true
        emissionClass:
          distribution: uniform
          params: {}
          bounds: []
          val: PHEMlight/PC_G_EU4
          is_attr: true
        tau:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.TauDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.Tau.val},${Blocks.SobolSequenceConfig.params.TauDev.val}}
          bounds:
          - 0.2
          - 2.5
          val: null
          is_attr: false
        accel:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.AccelDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.Accel.val},${Blocks.SobolSequenceConfig.params.AccelDev.val}}
          bounds:
          - 0.5
          - 6
          val: null
          is_attr: false
        decel:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.DecelDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.Decel.val},${Blocks.SobolSequenceConfig.params.DecelDev.val}}
          bounds:
          - 0.2
          - 6
          val: null
          is_attr: false
        minGap:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.minGapDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.minGap.val},${Blocks.SobolSequenceConfig.params.minGapDev.val}}
          bounds:
          - 0.1
          - 5
          val: null
          is_attr: false
        speedFactor:
          distribution: ${call:${import:external.src.sa_helpers.distributions.get},${Blocks.SobolSequenceConfig.params.speedFactorDist.val}}
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.speedFactor.val},${Blocks.SobolSequenceConfig.params.speedDev.val}}
          bounds:
          - 0.7
          - 1.3
          val: null
          is_attr: false
        impatience:
          distribution: uniform
          params: ${call:${import:external.src.sa_helpers.distributions.transform},${.distribution},${Blocks.SobolSequenceConfig.params.impatience.val},0.1}
          bounds:
          - 0
          - 0.6
          val: null
          is_attr: false
        length:
          distribution: uniform
          params:
            a: 4.0
            b: 6.0
          bounds: []
          val: null
          is_attr: false
        vClass:
          distribution: uniform
          params: {}
          bounds: []
          val: passenger
          is_attr: true
        lcCooperative:
          distribution: normal
          params:
            mu: 1.0
            sd: 0.2
          bounds: []
          val: null
          is_attr: false
        actionStepLength:
          distribution: uniform
          params: {}
          bounds: []
          val: 0.2
          is_attr: true
        jmTimegapMinor:
          distribution: uniform
          params:
            a: 3.0
            b: 6.0
          bounds: []
          val: null
          is_attr: false
        lcKeepRight:
          distribution: uniform
          params:
            a: ${..bounds[0]}
            b: ${..bounds[1]}
          bounds:
          - 0.3
          - 0.7
          val: null
          is_attr: false
        lcOvertakeRight:
          distribution: uniform
          params:
            a: ${..bounds[0]}
            b: ${..bounds[1]}
          bounds:
          - 0.0
          - 0.1
          val: null
          is_attr: false
      seed: ${Blocks.SobolSequenceConfig.params.RandomSeed.val}
      decimal_places: 5
      num_samples: ${int:${math:1000 - 1000 * ${Blocks.SobolSequenceConfig.params.FleetComposition.val}}}
    save_path: ${Metadata.cwd}/vehDist.in.xml
    distribution_name: vehDist
  RandomTripsConfig:
    net_file: ${Blocks.SimulationConfig.net_file}
    output_file: ${Metadata.cwd}/random.trips.xml
    seed: ${Blocks.SobolSequenceConfig.params.RandomSeed.val}
    additional_args:
    - -L
    - --fringe-factor
    - max
    - --speed-exponent
    - '0'
  RouteSamplerConfig:
    turn_file: ${Metadata.simulation_root}/../data/TSB_data/2023-07-01_2023-08-31/turns.in.xml
    output_file: ${Metadata.cwd}/routesampler.rou.xml
    random_route_file: ${Blocks.RandomTripsConfig.output_file}
    additional_args:
    - --optimize
    - full
    - --minimize-vehicles
    - ${uniform:0.9,0.99}
    - -a
    - departLane="best" departSpeed="avg" type="vehDist"
    - --write-flows
    - number
    - --weighted
    seed: ${Blocks.SobolSequenceConfig.params.RandomSeed.val}
  SimulationConfig:
    start_time: 0
    end_time: 9600
    net_file: ${Metadata.simulation_root}/network/net.net.xml
    gui: false
    route_files:
    - ${Blocks.RouteSamplerConfig.output_file}
    additional_files:
    - ${Metadata.cwd}/vehDist.in.xml
    - ${Blocks.XMLChangeOutputConfig.changes[0].target}
    - ${Blocks.XMLChangeOutputConfig.changes[1].target}
    - ${Blocks.XMLChangeOutputConfig.changes[2].target}
    - ${Metadata.simulation_root}/additional/signals/63082002.NEMA.Coordinated.xml
    - ${Metadata.simulation_root}/additional/signals/63082003.NEMA.Coordinated.xml
    - ${Metadata.simulation_root}/additional/signals/63082004.NEMA.Coordinated.xml
    step_length: 0.1
    additional_sim_params:
    - --seed
    - ${int:${Blocks.SobolSequenceConfig.params.RandomSeed.val}}
    - --start
    - --tripinfo-output
    - ${Blocks.XMLConvertConfig.source}
    - --tripinfo-output.write-unfinished
    - --device.emissions.begin
    - ${Blocks.SimulationConfig.warmup_time}
    - --device.emissions.probability
    - '1'
    - --emission-output
    - ${Metadata.cwd}/emissions.out.xml
    simulation_output: ${Metadata.cwd}/sumo_output.txt
    warmup_time: 1800
    make_cmd: ${import:simulation.make_cmd}
    start_time_rw: null
    runner_function: null
    runner_function_config: {}
    socket_listeners: null
Pipeline:
  pipeline:
  - block: RunSimulation
    producers:
    - function: producers.generate_sobol_sequence
      config: ${Blocks.SobolSequenceConfig}
    consumers:
    - function: ${import:xml.update_output_file}
      config: ${Blocks.XMLChangeOutputConfig}
    - function: vehicle_distributions.create_multi_type_distribution
      config: ${Blocks.MultiTypeCFConfig}
    - function: routesampler.call_random_trips
      config: ${Blocks.RandomTripsConfig}
    - function: routesampler.call_route_sampler
      config: ${Blocks.RouteSamplerConfig}
    - function: simulation.run_sumo
      config: ${Blocks.SimulationConfig}
    - function: ${import:xml.convert_xml_to_parquet}
      config: ${Blocks.XMLConvertConfig}
    - function: ${import:xml.convert_xml_to_parquet}
      config:
        source: ${Blocks.XMLChangeOutputConfig.changes[1].new_output}
        target: ${Metadata.cwd}/detectors.parquet
        delete_source: true
        elements:
        - name: interval
          attributes:
          - begin
          - end
          - id
          - sampledSeconds
          - nVehEntered
          - nVehLeft
          - nVehSeen
          - meanSpeed
          - meanTimeLoss
    - function: external.src.calibration.metrics.usdot_calibrate
      config:
        sim_file: ${Metadata.cwd}/detectors.parquet
        calibrate_file: ${Metadata.simulation_root}/../data/TSB_data/2023-07-01_2023-08-31/calibrate.parquet
        detector_mapping: ${Metadata.simulation_root}/../data/detector_mappings/radar_detector_mapping.yaml
        output_file: ${Metadata.cwd}/usdot_res.parquet
        start_time: '2023-07-24 05:30:00'
        warmup: ${Blocks.SimulationConfig.warmup_time}
        calibrate_detectors:
        - tl: '63082002'
          detectors:
          - EB
        - tl: '63082003'
          detectors:
          - WB_advance
          - EB
        - tl: '63082004'
          detectors:
          - WB
        calibration_passed: true
    - function: external.src.sa_helpers.metrics.get_sa_results
      config:
        trip_info_file: ${Blocks.XMLConvertConfig.target}
        detector_file: ${Metadata.cwd}/detectors.parquet
        warmup_time: ${Blocks.SimulationConfig.warmup_time}
        total_fuel_l: 1035.6267080859234
        average_fc: 20.665279198419906
        average_speed: 10.681280451783575
        average_delay: 64.91891767988838
        average_travel_time: 119.1948375523221
        delay_ratio: 0.4434010952380821
        total_vehicles: 5017
    - function: emissions.fast_total_energy
      config: ${Blocks.FuelTotalConfig}
    - function: ${import:io.save_config}
      config:
        save_path: ${Metadata.cwd}/config.yaml
    - function: ${import:io.rm_file}
      config:
        rm_files:
        - ${Blocks.XMLChangeOutputConfig.changes[0].target}
        - ${Blocks.XMLChangeOutputConfig.changes[1].target}
        - ${Metadata.cwd}/detectors.parquet
        - ${Metadata.cwd}/random.trips.xml
        - ${Metadata.cwd}/vehDist.in.xml
        - ${Metadata.cwd}/routes.add.xml
        - ${Metadata.cwd}/routesampler.rou.xml
        - ${Metadata.cwd}/per_phase.e2.add.xml
        - ${Metadata.cwd}/truckDist.in.xml
        - ${Metadata.cwd}/carDist.in.xml
    parallel: true
    number_of_workers: 64
  executor: ray
  parallel_proc: auto
